---
title: "L6.4: Implementing Conditional Logistic Regression"
subtitle: "BIOS 6612"
author: "Julia Wrobel"
date: March 1 , 2021
header-includes:
   - \usepackage{bm}
output:
  powerpoint_presentation:
    reference_doc: ../cu_style.pptx
---

```{r, echo= FALSE, include = FALSE}
library(tidyverse)

knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  fig.width = 7,
  fig.height = 5
)

theme_set(theme_bw() + theme(legend.position = "bottom"))
```

## Overview

Today, we cover:

* Conditional logistic regression in R




## Inference with Conditional Logistic Regression

For individual parameters, both the likelihood ratio test and Wald test are still valid.

* LRT is better for small sample sizes
* Wald is the default


<br>

Goodness-of-Fit

* Can use Hosmer-Lemeshow statistic (L4.4, L5.2)

## Example: Infertility after miscarriage or abortion

A study was conducted in Greece (Trichopoulous et al, 1976) to estimate the effect of spontaneous abortions (miscarriage) and induced abortions on subsequent risk of infertility.

<br>

* Cases: 100 women with secondary infertility
  * Secondary infertility is the inability to become pregnant after previously giving birth 
  
<br>

* Controls: 2 healthy controls per case
  * From the same hospital as cases, matched on age, parity (number of pregnancies carried to a viable gestational age), and level of education

## Example: Infertility after miscarriage or abortion

Variables in the dataset are:

* `case`: 1 for women with infertility, 0 for healthy controls
* `spontaneous`: categorical variable indicating number of spontaneous abortions (0 = 0, 1 =1, 2 = 2+)
* `induced`: categorical variable indicating number of induced abortions (0 = 0, 1 =1, 2 = 2+)
* `stratum`: denotes which matched sets an observation belongs to

```{r, echo = TRUE}
data("infert") # data is included as part of base R

infert = infert %>%
  mutate(induced = factor(induced),
         spontaneous = factor(spontaneous)) %>%
  select(-pooled.stratum)

head(infert, 3)
```


## Ignoring matching factors

We could consider not accounting for matching at all and just running regular logistic regression.

<br>

```{r, echo = TRUE}
model_regularLR = glm(case ~ induced + spontaneous,
                      data = infert, 
                      family = binomial)

#summary(model_regularLR)$coefficients
```

## Adjusting for matching factors as covariates

We could also consider accounting for matching factors (age, parity, and education) as covariates in a regular logistic regression.

<br>

```{r, echo = TRUE}
model_adjLR = glm(case ~ induced + spontaneous + 
                    age + parity + education,
                      data = infert, 
                  family = binomial)

#summary(model_adjLR)$coefficients
```


## Regular logistic regression with matched data

Without adjusting for matching variables, only spontaneous abortion is a significant predictor of fertility. With adjustment, both spontaneous and induced abortion are significant.

<br>

* Best method is to properly account for matching using conditional logistic regression

```{r}
rbind(broom::tidy(model_regularLR, conf.int = TRUE) %>%
  mutate(model = "unadj LR") %>%
  select(model, term, estimate, conf.low, conf.high, p.value),
  broom::tidy(model_adjLR, conf.int = TRUE) %>%
    filter(term %in% c("(Intercept)", "induced1",  "induced2", "spontaneous1", "spontaneous2")) %>%
  mutate(model = "adj LR") %>%
  select(model, term, estimate, conf.low, conf.high, p.value)
) %>%
  mutate(p.value = format.pval(p.value, digits = 2)) %>%
  arrange(term) %>%
  knitr::kable(digits = 2)
```


## Conditional logistic regression in R

Uses the `clogit` function from the `survival` package. Data is already in the format needed for this analysis (one row per patient, variable to indicate stratum/matched set)

```{r, echo = TRUE}
library(survival)

model_condLR = clogit(case ~  # variable for case or control status
                      induced + spontaneous + # exposure variables
                      strata(stratum), # variable indicating matched sets
                      data = infert)
```

## Conditional logistic regression in R

```{r}
summary(model_condLR)
```



## Comparing coefficients across models



```{r}
rbind(broom::tidy(model_regularLR, conf.int = TRUE) %>%
  mutate(model = "unadj LR") %>%
  select(model, term, estimate, conf.low, conf.high, p.value),
  broom::tidy(model_adjLR, conf.int = TRUE) %>%
    filter(term %in% c("(Intercept)", "induced1",  "induced2", "spontaneous1", "spontaneous2")) %>%
  mutate(model = "adj LR") %>%
  select(model, term, estimate, conf.low, conf.high, p.value),
  broom::tidy(model_condLR, conf.int = TRUE) %>%
    filter(term %in% c("induced1",  "induced2", "spontaneous1", "spontaneous2")) %>%
  mutate(model = "conditional LR") %>%
  select(model, term, estimate, conf.low, conf.high, p.value)) %>%
  mutate(p.value = format.pval(p.value, digits = 2)) %>%
  arrange(term) %>%
  knitr::kable(digits = 2)
```
